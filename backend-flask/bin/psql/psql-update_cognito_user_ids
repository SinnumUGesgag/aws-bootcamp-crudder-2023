#!/usr/bin/env python3

import boto3
import os
import sys

current_path = os.path.dirname(os.path.abspath(__file__))
parent_path = os.path.abspath(os.path.join(current_path, "..", ".."))
sys.path.append(parent_path)

from lib.db import InteractSQLDB



def update_users_with_cognito_user_ids(handle, sub):
	sql = """
		UPDATE public.users
		SET cognito_user_id = %(sub)s
		WHERE
			users.handle = %(handle)s;
	"""

	pSQLocalUrl = 'PSQL_CRUDDUR_LH_URL'
	
	InteractSQLDB(pSQLocalUrl).query_commit(sql,
	{'handle': handle,'sub': sub}
	)


def get_cognito_user_ids():
	userpool_id = os.getenv("MY_COGNITO_USER_POOL_ID")
	client = boto3.client('cognito-idp')

	parameters = {
		'UserPoolId': userpool_id,
		'AttributesToGet': [
		'preferred_username',
		'sub'
		]
	}

	response = client.list_users(**parameters)
	users = response['Users']

	dict_users = {}
	for user in users:
		attributes = user['Attributes']
		sub			= next((a for a in attributes if a["Name"] == 'sub'), None)
		handle		= next((a for a in attributes if a["Name"] == 'preferred_username'), None)
		dict_users[handle['Value']] = sub['Value']
		
	print(f"---- USERS: {dict_users} ||||")
	return dict_users

users = get_cognito_user_ids()

for handle, sub in users.items():
	print(f"""---- Handle & Sub Being Passsed In: {handle} , {sub} ||||""")
	update_users_with_cognito_user_ids(
		handle=handle, 
		sub=sub
	)
